{"title":"Notas en Modelamiento de trayectorias","markdown":{"headingText":"Notas en Modelamiento de trayectorias","containsRefs":false,"markdown":"\nLa idea de este procedimiento es la estimación de trayectorias para una variable longitudinal aproximadamente normal usando **R** y **Stata**. Está formulado en versión usuario, es decir, no se discuten aspectos matemáticos, estadísticos o de programación. Se prefirió este enfoque para que la alumna pueda implementar de manera sencilla en su Tesis y no a la medida del analista.\n\n## Desarrollo de la idea\n\nLa idea fue presentada como una forma de estimar trayectorias para un grupo de personas con valores de BMI (Bodd Mass Index) en varias edades, para ello se eligió el procedimiento descrito por Jones (2001) el cual desarrolló un método basado en un ajuste de polinomios para modelar trayectorias.\n\nUna trayectoria puede ser lineal o una curva en una forma exponencial o combinaciones mediante polinomios, la complejidad de la curva la da el usuario y ese es precisamente uno de los problemas de este método, ya que un polinomio de grado 3 o superior puede ajustar cualquier cosa y las trayectorias pueden no reflejar la realidad.\n\n![](C:\\Users\\Oliver\\Desktop\\B-Spline Trajectories\\img\\01.traj.ie.png)\n\nEntonces la idea es pedirle al sistema:\n\n- Un N de trayectorias (desde 2)\n- Un grado de complejidad (lineal, exponencial, cúbico, etc.)\n\nEl programa, a partir de las las trayectorias estimadas le asignará a cada sujeto una probabilidad de pertenecer. Francis (2016) indica usar un 70%, si tiene menos probabilidad se descarta la observación. Además se obtiene como output la representación gráfica de las trayectorias estimadas.\n\nEste sistema se denomina TRAJ por el nombre que el autor le dio en SAS, también desarrolló una versión para Stata que facilita mucho el modelamiento\n\nEn la página del autor se encuentran ejemplos y los script para SAS y Stata [http://www.andrew.cmu.edu/user/bjones/](http://www.andrew.cmu.edu/user/bjones/)\n\n```\n// To install the Stata version:\nnet from http://www.andrew.cmu.edu/user/bjones/traj\nnet install traj, force\nhelp traj\n```\n\n## B-Splines\n\nSugerido el método se recibió la recomendación de considerar el uso de \"splines cúbicos\", en Paraskevi 2018 se muestra que el ajuste usando esta metodología se acerca más a la realidad, en su exposición usa datos con trayectorias conocidas y pone a prueba algunas metodologías.\n\n> *A muy, pero muy grandes rasgos* los splines funcionan como las series de Fourier, estas indican que cualquier onda está compuesta por la suma de ondas de menor grado. O sea, el sistema se puede entender como la suma de subsistemas. En los splines se aplica la misma idea, mientras más nivel le doy al spline estoy diciendo que la trayectoria final está compuesta por la suma de más partes.\n>\n> En Wikipedia uno se puede hacer una idea de esto. [https://es.wikipedia.org/wiki/Spline](https://es.wikipedia.org/wiki/Spline)\n\nEntonces se sugiere usar el paquete **splines** de **R** para estimar los splines basales y con estos resultados alimentar el programa TRAJ en Stata indicando que el grado del polinomio sea cero.\n\n## Desarrollo de un ejemplo\n\nVamos a tomar el primer ejemplo de la página del autor, pero en lugar de hacer todo en TRAJ haremos la implementación de B-Splines.\n\nEste ejemplo usa los datos de **opposition** de 138 sujetos del *Montreal Longitudinal  Study*, en el cual profesores evaluaron estudiantes anualmente a las edades de 6 y 10 - 15 en la escala de *opposition* que tiene un rango de 0 a 10. \n\nVamos a ajustar 2 trayectorias cúbicas a estos datos.\n\n### 1. Los datos\n\nLos datos deben estar en un formato a lo ancho para Stata y longitudinal para R, como en Stata es más simple minimizaremos el tratamiento de datos en R. Los datos del archivo `OPPOSITN.xlsx` lucen de la siguiente forma.\n\n![](C:\\Users\\Oliver\\Desktop\\B-Spline Trajectories\\img\\02.opo.png)\n\nEl tiempo es **T** y la variable de oposición es **V**. \n\n> **Importante**: el tiempo se puede expresar como cualquier variable numérica, aquí se dejo como el autor desarrolla el ejemplo. La alumna utilizó meses y funcionó sin problemas.\n\nSi nos fijamos el sujeto `id = 1004` tiene datos faltantes, ocurre que como este sistema usa de fondo un modelo mixto no es estrictamente necesario que todos los sujetos tengan todos los datos, como es lógico se debe evitar esta situación, pero de ser, procurar excluir sujetos con muchos valores faltantes (máximo 2 por ejemplo).\n\n### 2. Reshape en Stata\n\nLo siguiente  será importar estos datos en Stata y cambiar su estructura. Lo primero es setear la carpeta de trabajo con el **comando cd**.\n\nPor ejemplo una carpeta en el escritorio de Windows\n\n```\nC:\\Users\\Oliver\\Desktop\\B-Spline Trajectories\n```\n\nEl Archivo de Excel deberá estar en una carpeta que contendrá todos los archivos y resultados. Los comando de Stata para importar el **Excel**, hacer el **reshape** y guardar el archivo para luego abrir en R son los siguiente. Por simplicidad es preferible que la base de datos solo tenga id, la medición y el tiempo, nada más.\n\n```\n* Cargar el espacio de trabajo\ncd \"D:\\.....\\TRAJ\\Ejemplo Splines\"\n\n* Importar el Excel\nimport excel using \"OPPOSITN.xlsx\", clear first sheet(\"OPPOSITN\")\n\n* Guardar los datos en formato Stata 12 para tener los datos en versión WIDE\nsaveold \"OPPOSITN_wide.dta\", replace\n\n* Reshape de wide a long\nreshape long V0 T0, i(id) j(epoch)\n\n* El tiempo quedó en T0 y la medición en V0. Cambiar nombres\nrename (V0 T0) (data time)\n\n* Guardar formato long para pasar al R\nsave \"OPPOSITN_long.dta\", replace\n```\n\nLos datos lucen así recién importados\n\n![](C:\\Users\\Oliver\\Desktop\\B-Spline Trajectories\\img\\03.statawide.png)\n\nCon el reshape\n\n![](C:\\Users\\Oliver\\Desktop\\B-Spline Trajectories\\img\\04.statalong.png)\n\nSe guarda todo en el archivo **\"OPPOSITN_long.dta\"**\n\n### 3. Spline bases en R\n\nAhora toca llevar estos datos a R para calcular el spline basis. Vamos a usar un DF (grados de libertad) igual a 4, lo cual equivale a un spline de tercer nivel (cúbico). Siempre tiene un valor +1 y por eso se escribe `DF = 4`. En la explicación de Wikipedia se entiende bien la razón de esto.\n\nHay que instalar la librería **haven** con `install.packages(\"haven\")` para leer el archivo de Stata (.DTA), la librería **splines** viene de base con el R. La librería `foreign` solo lee archivos **dta** hasta versión 12, por eso usamos `haven`.\n\nComo siempre lo primero será setear el directorio de trabajo. En la parte de Stata teníamos `\"D:\\.....\\TRAJ\\Ejemplo Splines\"` como ejemplo. Esto es en Windows, notar que las carpetas se separan con la barra inclinada a la izquierda, en **R** es a la derecha y se usa el comando `setwd()` para configurar la carpeta de trabajo.\n\n```R\n# Setear directorio de trabajo donde estan los archivos\nsetwd(\"D:/...../TRAJ/Ejemplo Splines\")\n \n# Cargar los datos con el paquete haven\nlibrary(haven)\ndatos <- read_dta(\"OPPOSITN_long.dta\")\n \n# Mirar los datos\n head(datos, 7)\n# A tibble: 7 x 4\n     id epoch  data  time\n  <dbl> <dbl> <dbl> <dbl>\n1  1000     1     2  -0.6\n2  1000     2     0  -0.2\n3  1000     3     1  -0.1\n4  1000     4     0   0  \n5  1000     5     0   0.1\n6  1000     6     0   0.2\n7  1000     7     0   0.3\n```\n\nVemos que los datos están en el objeto \"datos\" y son los mismos del Stata.\n\n```R\n# Calculamos un spline basis cúbico \nlibrary(splines)\nspline <- bs(datos$time, df=4)\n \n# El resultado es una matriz, lo transformamos en data frame\n# y ponemos nombres a las variables\nspline <- data.frame(spline)\nnames(spline) <- c(\"sp_uno\", \"sp_dos\", \"sp_tre\", \"sp_cua\")\nhead(spline, 7)\n\n       sp_uno     sp_dos    sp_tre     sp_cua\n1 0.000000000 0.00000000 0.0000000 0.00000000\n2 0.403292181 0.42798354 0.1316872 0.00000000\n3 0.249485597 0.48868313 0.2572016 0.00000000\n4 0.111111111 0.44444444 0.4444444 0.00000000\n5 0.032921811 0.27983539 0.6502058 0.03703704\n6 0.004115226 0.09053498 0.6090535 0.29629630\n7 0.000000000 0.00000000 0.0000000 1.00000000\n```\n\nEl spline basis es una matriz y en R las planillas son un objeto **data.frame** entonces pasamos el spline basis a data frame y asignamos los nombres a las variables. **Es importante que no tengan números para el reshape posterior.**\n\nEn este ejemplo las 7 lineas son los 7 tiempos del primer sujeto su spline del tiempo está compuesto por la suma de estos 3 + 1 splines. Ahora pegamos esto a los datos y exportamos a un archivo de Stata.\n\n```R\n# Juntamos los datos y los splines\ndatos_spline <- cbind(datos, spline)\nhead(datos_spline, 7)\n    id epoch data time      sp_uno     sp_dos    sp_tre     sp_cua\n1 1000     1    2 -0.6 0.000000000 0.00000000 0.0000000 0.00000000\n2 1000     2    0 -0.2 0.403292181 0.42798354 0.1316872 0.00000000\n3 1000     3    1 -0.1 0.249485597 0.48868313 0.2572016 0.00000000\n4 1000     4    0  0.0 0.111111111 0.44444444 0.4444444 0.00000000\n5 1000     5    0  0.1 0.032921811 0.27983539 0.6502058 0.03703704\n6 1000     6    0  0.2 0.004115226 0.09053498 0.6090535 0.29629630\n7 1000     7    0  0.3 0.000000000 0.00000000 0.0000000 1.00000000\n \n# Listo, ahora exporetamos a stata\nwrite_dta(datos_spline, \"OPPOSITN_longSpline.dta\")\n```\n\nY listo, ya podemos irnos a Stata. \n\n### 4. Estimación de las trayectorias en Stata\n\nLo primero será instalar el paquete TRAJ en el Stata si es que ya no está instalado, escribiendo los siguientes comandos en un do-file o en la consola.\n\n```\n// To install the Stata version:\nnet from http://www.andrew.cmu.edu/user/bjones/traj\nnet install traj, force\nhelp traj\n```\n\nLuego cargamos los datos, no olvidar que seguimos en el mismo directorio de trabajo si es que no cerramos el Stata, si lo cerramos habría que usar nuevamente el comando **cd** como ya se explicó.\n\n```\n* Cargar el archivo que hicimos en R\nuse \"OPPOSITN_longSpline.dta\", clear\n\n* Reshape para dejar en wide\nreshape wide data time sp_uno sp_dos sp_tre sp_cua, i(id) j(epoch)\n```\n\nEl resumen del reshape es:\n\n![](C:\\Users\\Oliver\\Desktop\\B-Spline Trajectories\\img\\05_reshape.png)\n\nComo vemos pasamos de 8 variables a 43, son muchas variables... 7 de data, 7 de time y 7x4 del spline basis. Ahora vamos a calcular trayectorias, como vamos a necesitar los spline basis del tiempo usaremos  el comodin ***** en lugar de escribir todas las variables.\n\n#### Explicación del comando\n\nEl comando es el siguiente y vamos a explicar paso a paso qué significa.\n\n```\ntraj, var(data*) indep(time*) model(cnorm) min(0) max(10) order(0 0) tcov(sp_uno* sp_dos* sp_tre* sp_cua*)\n```\n\n* `traj`: Es el comando principal\n* `var(data*)`: todas las variables de medición, el asterisco significa data1, data2, etc.\n* `indep(time*)`: Las variables de tiempo.\n* `model(cnorm)`: La variable de medición es aproximadamente normal, hay otras opciones que se pueden consultar en la ayuda del paquete TRAJ.\n* `min (0) max (10)`: Son los límites de la variable de medición.\n* `order(0 0)`:  Es la cantidad de trayectorias que deseamos calcular, si quisiéramos 3 habría que escribir `(0 0 0)`, como en este caso estamos usando splines basis como covariable del tiempo y no TRAJ de polinomio tendrán valor cero. Si estuviéramos usando TRAJ (y no splines) habría que indicar el nivel de cada trayectoria, por ejemplo si queremos calcular tres trayectorias la primera cuadrática y tres cúbicas se escribiría `(2 3 3)` y sin las covariables de tiempo.\n\n* `tcov(sp_uno* sp_dos* sp_tre* sp_cua*)`: Usamos el spline basis como covariables de tiempo. \n\nY así de esta forma usamos el paquete TRAJ de Stata para calcular trayectorias con splines.\n\n#### Explicación del resultado\n\n```\n==== traj stata plugin ====  Jones BL  Nagin DS,  build: Apr  8 2019\n \n138 observations read.\n138 observations used in the trajectory model.\n \nWARNING: False convergence\n                        Maximum Likelihood Estimates\n                        Model: Censored Normal (cnorm)\n\n                                       Standard       T for H0:\n Group   Parameter        Estimate        Error     Parameter=0   Prob > |T|\n \n 1       Intercept         0.82586      0.33139           2.492       0.0129\n         sp_uno1          -0.23329      1.89150          -0.123       0.9019\n         sp_dos1           0.04742      1.53175           0.031       0.9753\n         sp_tre1          -2.52340      0.76126          -3.315       0.0010\n         sp_cua1          -1.88785      0.51772          -3.646       0.0003\n \n 2       Intercept         3.24895      0.49999           6.498       0.0000\n         sp_uno1          -1.02550      2.63711          -0.389       0.6975\n         sp_dos1           4.43774      2.00781           2.210       0.0273\n         sp_tre1          -2.85030      1.02318          -2.786       0.0055\n         sp_cua1           0.13589      0.71333           0.191       0.8490\n \n         Sigma             2.76498      0.09521          29.042       0.0000\n \n  Group membership\n 1       (%)              68.09676      5.31008          12.824       0.0000\n 2       (%)              31.90324      5.31008           6.008       0.0000\n \n BIC= -1647.67 (N=901)  BIC= -1636.41 (N=138)  AIC= -1618.85  ll=  -1606.85\n```\n\nPara buscar el mejor modelo de trayectorias que explique los datos usaremos los valores **BIC** o Criterio de información bayesiano, mientras más bajo mejor, de la misma forma que el **AIC** o Criterio de Información de Akaike.\n\nEl resto son la ecuación de cada trayectoria y los porcentajes de asignación de sujetos. Se puede graficar usando esa ecuación con el comando `trajplot`\n\n```\n* Hacer el gráfico de las trayectorias\ntrajplot\n```\n\n![](C:\\Users\\Oliver\\Desktop\\B-Spline Trajectories\\img\\06_traj2.png)\n\nY además en los datos se agregan tres variables, una por cada trayectoria indicando la probabilidad de pertenencia de cada sujeto.\n\n![](C:\\Users\\Oliver\\Desktop\\B-Spline Trajectories\\img\\07_trajp.png)\n\nEl sistema por defecto asigna a cada sujeto según la mayor probabilidad. Pero si seguimos el ejemplo de Francis (2007) podemos determinar que el mínimo para formar parte de un grupo sea 70%.\n\n## Iteración del modelo\n\nYa sabemos hacer un modelo de trayectorias con splines y traj, ahora hay que hacerlo en serio y para ello se deben calcular muchos modelos para elegir el que mejor describe la muestra, para ello tendremos que calcular varios splines y varias trayectorias. Por ejemplo de 1 a 3 splines y 2 a 6 trayectorias. La secuencia sería:\n\n1. Calcular un spline basis en R con `df = 2`\n   A) Calcular en Stata 2 trayectorias\n   B) Calcular en Stata 3 trayectorias\n   C) Calcular en Stata 4 trayectorias\n   D) Calcular en Stata 5 trayectorias\n   E) Calcular en Stata 6 trayectorias\n   \n2. Calcular un spline basis en R con `df = 3`\n   A) Calcular en Stata 2 trayectorias\n   B) Calcular en Stata 3 trayectorias\n   C) Calcular en Stata 4 trayectorias\n   D) Calcular en Stata 5 trayectorias\n   E) Calcular en Stata 6 trayectorias\n   \n3. Calcular un spline basis en R con `df = 4`\n   A) Calcular en Stata 2 trayectorias\n   B) Calcular en Stata 3 trayectorias\n   C) Calcular en Stata 4 trayectorias\n   D) Calcular en Stata 5 trayectorias\n   E) Calcular en Stata 6 trayectorias\n\nSon 15 modelos y elegiremos el que tenga valores de **BIC** más bajos y sea lo más coherente con lo que conocemos de los datos. No porque un modelo tenga el valor mejor de BIC o AIC quiere decir que sea el modelo que mejor explica, se deben considerar ambas cosas.\n\n## Notas finales\n\nTambién se puede modela usando covariables que pudieran afectar el desarrollo de las trayectorias, se pueden usar modelos binarios y varias cosas más que se pueden consultar en la ayuda del TRAJ con `help traj`.\n\nSi bien las trayectorias con splines ajustan muy bien, no son tan diferentes de las modeladas con polinomios, sin embargo, con splines son más suaves y coherentes.\n\nEfectivamente se podría hacer todo en R replicando el programa de SAS, no debiera ser muy complicado, además existen librerías de R para ajustar regresiones con splines. Pero este es un trabajo para alguien ajeno al data science, por eso se hizo de esta manera.\n\n### Bibliografia\n\n* En los papers de Jones está el desarrollo del modelo TRAJ\n* En Francis está un excelente ejemplo desde el cual se infirió este manual\n* Nagin es para más antecedentes\n\n### El código\n\nHay dos script en la carpeta el de Stata **splinesStata.do** y el de R **splinesR**. Los datos están en **OPPOSITN.xlsx** y el resto de archivos son biblio y archivos creados en el proceso.\n\n\n\n​\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tProf. Oliver Rojas Bustamante, Marzo 2019\n\n\n\n\n\n\n\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"css":["../styles.css"],"output-file":"B-Spline TRAJ.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.5.57","editor":"visual","theme":"cosmo","toc-title":"Contenido"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}