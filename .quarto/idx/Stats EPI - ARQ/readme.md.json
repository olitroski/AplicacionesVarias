{"title":"Estadísticas Episodios","markdown":{"headingText":"Estadísticas Episodios","containsRefs":false,"markdown":"[TOC]\n\n\nEste documento describe el detalle del cálculo y obtención de las variables que componen las estadísticas de cada período de día o noche de la tabla EPI de la aplicación `Actividorm` y la app nueva. \n\nEl desarrollo de la app nueva tiene en cuenta que hay muchos análisis anteriores (a la fecha), por esa razón se ha replicado el modelo de la tabla EPI como formula para procesar datos viejos usando las funciones nuevas.\n\n## Definiciones\n\nEste vocabulario se usará durante todo el proceso y en los comentarios del código:\n\n1. Un **id** corresponde un **sujeto**\n2. Cada sujeto tendrá una serie de **episodios** de sueño o vigilia determinados por el estado actigráfico filtrado desde la detección del algoritmo de MiniMitter.\n3. Estos episodios se encuentran agrupados en **periodos** de día o noche\n4. Los períodos son numerados secuencialmente según orden de aparición **01, 02, 03**\n5. El primer período corresponde *siempre* al **Dia 01** el día que el sujeto se lleva el actígrafo.\n6. Luego se sucede el primer par de períodos consecutivos **Noche 02** seguido de **Dia 02**\n7. Este par de períodos consecutivos puede durar más o menos de 24 horas\n\n## Consejos para el análisis\n\nComo existen periodos inutilizables porque los sujetos se retiran el actígrafo, pensar en hacer análisis 24 horas no es siempre posible porque se requieren pares consecutivos, tipo  **Noche 02** > **Dia 02**; solo de existir un par válido de este tipo (en un sujeto) se podrían hacer cálculos de tipo **causa y efecto** de la noche al día. Para trabajar el efecto del día hacia la noche será necesario contar con un par consecutivo de tipo **Dia 02** > **Noche 03**.\n\n*En algún momento incluiré esta opción de día completo*\n\nSe debe considerar que estas funciones no hacen cálculos por sujeto, **hacen cálculos sobre el período**, posteriormente se podría promediar para consolidar por sujeto, sin embargo, hacer esto es *unwise* ya que se pierde la información de los períodos al igual que el tamaño muestral, se recomienda que los datos sean analizados con modelos de regresión mixta para aprovechar al máximo la información. Medidas repetidas en SPSS puede no resultar porque el sistema no permitirá muestras desbalanceadas o con valores faltantes.\n\n> Nota mental:\n>\n> En los settings del `Actividorm` y la app nueva se configura un parámetro para determinar la consolidación de un estado de sueño o vigilia, se llama **StateFilterDuration** (statedur en la app mia) y según he visto en algunos casos le asignan valores imposibles como 480 segundos por ejemplo.\n>\n> El uso de este parámetro depende del tamaño del *epoch*, porque el actígrafo no es continuo en segundos, la medida más pequeña son 15 segundos, si el actígrafo está configurado al minuto este parámetro sólo puede ser utilizado en saltos de 60 segundos. Simplemente no es posible, así que el `Actividorm` debe aproximarlo al *epoch* del actígrafo. En mi app está configurado en minutos, por defecto es `statedur = 00:05`.\n\n## Consejos para combinar tablas\n\nLos archivos de estadísticas por período se calculan por separado, es decir, hora de inicio estará en una tabla diferente que las duraciones. Dado que el el identificador de sujeto es el **Id** y los períodos de ese sujeto son exclusivos de él, para combinar tablas se tendrá que crear una variable de **llave** que combine ambas variables. Así se crea un identificador único por fila.\n\nSe pueden unir por ejemplo separando por un guión bajo. \n\n```\n\"10524_Dia 01\"\n\"10524_Noche 02\"\n\"10524_Dia 02\"\n\"10524_Noche 03\"\n```\n\nPara hacer este cálculo en **Excel** se puede usar la fórmula `concantenar` o su versión abreviada con el operador `&`, en el ejemplo el `id`  es un valor de celda al igual que `periodo`.\n\n```\n=CONCATENAR(id, \"_\", periodo)\n=id & \"_\" & periodo\n```\n\nAunque es un poco tedioso se puede usar la función `buscarv` para combinar las tablas, no es problema **mientas exista una llave** que combine id y periodo, es simple y sencillo.\n\nEn el caso de **Stata** se debe usar el comando `generate` y los nombres de las variables. Para combinar usar el comando `merge`.\n\n```\ngenerate key = id + \"_\" + periodo\n```\n\nComo **SPSS** es *\"especial\"* concatenar solo es posible cuando ambas variables son de tipo *cadena* y aun así no se le puede agregar un guión bajo a menos que cree una variable que solo contenga ese carácter. Considerando además que el sistema de combinación de archivos de SPSS no es del todo intuitivo y existe la posibilidad de perder registros (y por muchas otras razones) lo más recomendable es no usar SPSS para esta tarea. Si se va a usar SPSS para el análisis se recomienda que la combinación de las tablas se realice en otro programa y luego traer los datos. \n\n## Hora decimal\n\nLa mayor parte de las veces se registrará la hora decimal, por el simple motivo que  las horas normales de tipo `15:44` no se pueden usar para hacer cálculos.\n\nLas horas normales tienen base 6, van de 0 a 59 (o 1 a 60 si se prefiere). Entonces las horas decimales se calculan como:\n\n```\nhora.decimal = hora + (minutos/60)\n```\n\nDe esta forma las `15:20` se transforma en `15.333`. Para interpretar este tipo de variable se toma la parte entera como la hora y la decimal se multiplica por 60 y se obtienen de vuelta los minutos.\n\nSi por algún obscuro motivo se quiere pasar estas horas a Excel o trabajarlas en los formatos nativos de SPSS o Stata *que le vaya bien* porque explicarlo me tomaría mucho rato.\n\n## Hora continua\n\nLas horas no son una variable circular aunque lo parezca, por esa razón en ocasiones hay que hacer un ajuste:\n\nExisten algunas horas que atraviesan la media noche y ocurre que el reloj resetea al llegar a ese punto, razón por la cual no se pueden calcular estadísticas, por ejemplo el promedio entre 23:30 y 02:30 es 13:00... otsea....\n\nPara solucionar esto el cálculo debe hacerse sumando 24 horas a la hora que pasa la media noche, es decir calcular el promedio entre 23:30 y 26:30 va a ser 25:00 y eso si es la 1 de la mañana. Por eso siempre hay que calcular los máximos y mínimos antes de usar variables de hora y chequear mediante un histograma.\n\nLa única variable que si o si puede tener este problema y tendrá una versión continua es la hora de inicio del período *Noche*, no obstante lo anterior, siempre se deben revisar las variables antes de trabajar.\n\n-----\n\n# Para trabajar con archivo antiguos\n\nHacer esto requiere programar un poco en R, solo es información útil para alguien que desee realizarlo. Las funciones debieran quedar cargadas en el *Global Environment* así que se podrían usar directamente. (cuando termine la librería)\n\n## 1. Leer el EPI\n\nDel Excel se debe pasar la tabla EPI a un CSV (por las fechas), básicamente es el EPI original. La variable **Nombre.Sujeto** debe contener el ID en numérico.\n\n```\n  Nombre.Sujeto Periodo.del.registro             Hora Estado Actividad Duracion..min.\n1         10013             Noche 01  03-08-2016 1:41      S      1388          290,0\n2         10013             Noche 01  03-08-2016 6:31      W      1333           29,0\n3         10013             Noche 01  03-08-2016 7:00      S       137           35,0\n4         10013               Dia 01  03-08-2016 7:35      W     23239           85,0\n5         10013               Dia 01  03-08-2016 9:00      S      1951          180,0\n6         10013               Dia 01 03-08-2016 12:00      W      2324           17,0\n  Promedio.actividad.por.minuto Numero.Episodio Episodio.del.estado\n1                           4,8               1                S001\n2                          46,0               2                W001\n3                           3,9               3                S002\n4                         273,4               4                W001\n5                          10,8               5                S001\n6                         136,7               6                W002\n```\n\nOjo que el original tiene un pie de página que se debe sacar.\n\n> La función a usar es `function_read.epi()` , ya la documentaré como corresponde\n\n## 2. Leer el ARQ\n\nMisma cosa pero más sencillo se necesita que tenga esta forma en formato CSV.\n\n> La función a usar es `function_read.arq`() que también documentaré.\n\n```\n  Nombre.Sujeto Periodo.del.registro         Jornada      Hora.Inicio\n1         10013               Dia 01 Dia Completo(a) 03-08-2016 07:35\n2         10013               Dia 02 Dia Completo(a) 04-08-2016 07:49\n3         10013               Dia 03 Dia Completo(a) 05-08-2016 07:34\n4         10013               Dia 04 Dia Completo(a) 06-08-2016 09:09\n5         10207               Dia 01 Dia Completo(a) 03-06-2016 07:34\n6         10207               Dia 04 Dia Completo(a) 06-06-2016 10:18\n```\n\nIndispensable que tenga el id en numérico, el período y le hora de inicio.\n\n## 3. Combinar\n\nLuego se combinan con **merge** mediante la variable **key** que será creada al pasar las funciones anteriores. Luego hay que sacar algunos episodios si fuera necesario, para ello usar la nota mental del punto 2 del pre procesado. El archivo final debe lucir asi.\n\n```\n   id periodo                hora estado actividad dur_min mean_act_min num_epi epi_estado\n10013  Dia 01 2016-08-03 07:35:00      W     23239      85        273.4       4       W001\n10013  Dia 01 2016-08-03 09:00:00      S      1951     180         10.8       5       S001\n10013  Dia 01 2016-08-03 12:00:00      W      2324      17        136.7       6       W002\n10013  Dia 01 2016-08-03 12:17:00      S         2      20          0.1       7       S002\n10013  Dia 01 2016-08-03 12:37:00      W     52688     213        247.4       8       W003\n10013  Dia 01 2016-08-03 16:10:00      S       632      21         30.1       9       S003\n```\n\n> 22.08.2020 Se sugiere error de procesado, era el ARQ. Es buena idea chequear que los registros calcen bien luego de procesar todo.\n\n------\n\n# Pre procesado \n\nLa tabla EPI del `Actividorm` al igual que la de la app nueva no se puede usar directamente para calcular las estadísticas de los períodos, debido a que se hace un pre-procesado que asegura la uniformidad de los registros para que luego no se produzcan errores. Las etapas de este proceso son las siguientes:\n\nEl pre-proceso se ejecuta sobre la tabla EPI ya depurada en el caso de tratar con archivos antiguos o directamente con la app nueva. \n\n> La función es: `function_ValidEvents()` que ya documentaré\n\n**Todo lo que se descarte queda en la tabla drop acompañado del id, periodo y motivo.**\n\n> Luego de pasar la función se deben extraer las tablas del objeto lista que produce esta función. Además de remover la variable **actividad**. Se puede usar este código como guía:\n>\n> ```R\n> # Pre procesar\n> epi <- function_ValidEvents(epi)\n> drop <- epi$drop\n> epi <- epi$datos\n> \n> # Validar que se pueda analizar\n> epi <- select(epi, -actividad)\n> check.epidata(epi)\n> ```\n\nA continuación el detalle de lo que hace esta función.\n\n## Descartar el Dia 01\n\nComo este día de registro no es completo porque no inicia desde el mínimo posible no se utiliza y en esta parte del procesado se descarta. Tanto la app nueva como `Actividorm` descartan este período para el cálculo de estadísticas.\n\n> 22.08.2020 Se actualiza para que incluya el \"Dia 01\" `Función 04 valid events ~ linea 40`\n\n\n\n## Periodos repetidos\n\nEn la app nueva no van a existir periodos repetidos porque el análisis se realiza una sola vez, pero cuando se analizan tablas EPI del `Actividorm` puede ocurrir que se reprocese un archivo AWD y existan 2 archivos y al compilar todo pueden quedar episodios repetidos. En esta etapa se descarta lo repetido.\n\n> Nota mental:\n>\n> En ciertas ocasiones puede ser que un sujeto tenga un falso inicio de sueño y por lo tanto noche, esto se detecta en el actograma, lo que ocurre es que se retrasa esa noche. En `Actividorm` esto se hace a mano y al procesar tablas EPI con este sistema obliga a eliminar los episodios previos al real inicio de la noche.\n>\n> Lo primero es que al combinar la tabla EPI con la tabla ARQ para descartar los períodos con errores hay que asegurarse de traerse la hora del episodio en ARQ. Así en R creando una variable lógica (TRUE o FALSE) se pueden descartar fácilmente estos episodios con error.\n>\n> ```R\n> epi <- arrange(epi, id, periodo, hora)\n> epi <- mutate(epi, edited = hora < hora.arq)\n> epi <- filter(epi, edited == FALSE)\n> ```\n>\n> Esto es usando la librería `dplyr` y lo que hace es ordenar por id, periodo y luego por hora, luego crea variable `edited` con verdadero si el episodio es menor que la hora del ARQ (la correcta) y luego nos quedamos con lo que sea mayor o igual a esa hora.\n\n## Crear periodos\n\nOriginalmente los periodos vienen con el día y el secuencial unido, pero en ocasiones se necesita calcular cosas solo para dia o noche, por ello se separa, pero no se descarta la variable.\n\nLas variables nuevas son:\n\n* `dia.noc` con valores día o noche\n* `seq.dia` con el correlativo\n\n## Mínimo de episodios\n\nLa para hacer cálculos y estadísticas se requiere un mínimo de episodios en un período, si una persona duerme toda la noche no se le puede calcular nada.\n\nOriginalmente se descartaban periodos con 1 episodio (no pueden haber 2) y solo se usaban 3 o más. En la última actualización se usan todo para que en caso que tenga solo un episodio se le pueda calcular horas de inicio y fin.\n\nSe recomienda descartar este tipo de episodios cuando se hacen análisis porque tendrán estadísticas de 0% y 100% y esto sesga un montón los promedios. Obvio no olvidar reportar para incluir en los resultados.\n\n> El código para descartar periodos de 1 episodio quedó comentado en la línea 91 del script de la función. De momento sólo se registra la ocurrencia, pero no se descarta nada.\n\n## Primer episodio\n\nLo siguiente que se chequea, por precaución es que un el primer episodio de un período sea concordante.\n\n* Si es Noche debe comenzar por Sueño\n* SI es Dia debe comenzar por Vigilia\n\nAntes generaba un error y descartaba el período ahora solo se guarda, por eso es bueno revisar esa tabla de cuando en vez.\n\n## Días de la semana\n\nOtro aspecto que no tiene el `Actividorm` es la definición del día. Dado que existen diferentes usos para el día de la semana o tal vez se quisiera hacer alguna combinación rara, se registra el día de la semana a la cual pertenece el periodo o el transito en el caso de la noche.\n\n### Dia del período\n\nEl día se define como el la fecha-hora del primer episodio de vigilia que ocurre igual o después de cierta hora (06:00 por ejemplo) y que tenga una duración determinada (mayor a 30 min por ejemplo).\n\nConsiderando esto el **día de la semana del período se extrae de la fecha del 1er episodio del día**. Por ejemplo el `25-04-2011` es Lunes, por lo tanto si hay un período día que inicie ese día será etiquetado como **Lunes**.\n\n### Noche del período\n\nDe la misma forma la noche se define cuando se encuentra un episodio de sueño posterior a cierta hora (*i.e.* 20:00) y que tenga una duración superior a un tiempo determinado (30 min por ejemplo).\n\nEl tiempo no es una variable circular y una vez que llega a las 23:59 técnicamente no pasa a 00:00 sino que a 24:00, es decir al día siguiente, por esta razón en un período de noche pueden ocurrir en 2 combinaciones.\n\n* Comenzar en una fecha y terminar un día después.\n* Comenzar y terminar en una misma fecha\n\nPor ejemplo un período de noche puede iniciar el `26-04-2011 22:46` y terminar el `27-04-2011 07:23` o sea transita desde un martes a un miércoles.\n\nOtra opción sería que comience el `27-04-2011 00:46` y terminar el `27-04-2011 07:23` o sea inicio y término en la misma fecha, aun así se etiquetará como de martes a miércoles.\n\n>  Etiquetando de esta forma cada período se puede tener una idea muy clara para poder asignar cada período según se necesite. \n\n## Redondear duración\n\nFinalmente decir que se usa una función de expansión de la data, se actualizó en algunos script pero en los más complicados como las estadísticas de duración se dejó aunque sea lento. Algún día lo veré... \n\nPara asegurar el cálculo y aún cuando lo más probable es que la duración de un episodio sea un número entero (mintuos) se redondea al valor más bajo, o sea 25.3 será 25.\n\nSe hizo esto porque algún registro traía un decimal. Pero el 99.9% de las veces viene un número entero.\n\n------\n\n# 1. Hora de Inicio\n\nEsta sección calcula la hora de inicio y variables asociadas del período de análisis. Los períodos de análisis pueden ser de noche o día porque tienen la misma estructura. Por ejemplo este extracto es la **Noche 02** del sujeto **10648** y contiene 3 episodios, 2 de sueño y 1 de vigilia. \n\n```\n   id            fec.hora estado dur_min mean_act actividad   hora     dia hora.abs  periodo\n10648 2016-09-14 22:18:00      S     494      6.5      3231 22.300 mié-jue       22 Noche 02\n10648 2016-09-15 06:32:00      W      42     67.3      2826  6.533 mié-jue        6 Noche 02\n10648 2016-09-15 07:14:00      S      31      9.0       278  7.233 mié-jue        7 Noche 02\n```\n\n## Variables de Inicio\n\nA partir de un período como este se calculan las siguientes variables.\n\n```\nVariable\tDescripción\n------------------------------------------------------------------------\nid\t\t\tId del sujeto\nperiod\t\tPeriodo de análisis\ndia_noc\t\tDía o noche correspondiente al período\nstage_ini\tEstado de Sueño o Vigilia del episodio de inicio \nhi\t\t\tHora de inicio del período (decimal)\nhi_abs\t\tHora de inicio del período (Valor absoluto)\nhi_m\t\tHora de la mitad del episodio de inicio\nhf\t\t\tHora de fin del período (Decimal)\nhf2\t\t\tHora de fin del período (Formato contínuo)\nwday\t\tDia de la semana de la fecha (formato transito para la noche)\nfecha\t\tFecha del episodio de inicio (para chequeos)\nkey\t\t\tPara cruzar bases de datos (identifica id + periodo)\n```\n\nLa hora de la mitad de la noche se calcula como se explica en el apartado de conteos.\n\n## Errores detectados\n\n>  Este es un ejemplo, podría ser noche también.\n\nAl revisar los datos en el proyecto de las leches en 6 meses (por ejemplo) se encontraron horas de inicio anómalas que el `Actividorm` determinó como inicio del día. El programa define la detección del día así:\n\n> El día se inicia al encontrar un período de vigilia luego de la hora indicada en *AwakeSearchTime* que dure al menos *AwakeDuration* segundos y que tenga menos de *AwakeMaximumSleep* segundos de sueño\n\nEsto implica que no debieran existir días que inicien antes de las 06:00 (según configuración). Por ejemplo el `id = 10615` en el `Dia 05` inicia a las 03:43, el extracto del archivo EPI es el siguiente:\n\n| id    | fec.hora            | estado | dur_min | dia.noc | seq.dia | hora   |\n| ----- | ------------------- | ------ | ------- | ------- | ------- | ------ |\n| 10615 | 2016-10-03 03:43:00 | W      | 184     | Dia     | 05      | 3.717  |\n| 10615 | 2016-10-03 06:48:00 | S      | 254     | Dia     | 05      | 6.8    |\n| 10615 | 2016-10-03 11:02:00 | W      | 367     | Dia     | 05      | 11.033 |\n| 10615 | 2016-10-03 17:10:00 | S      | 11      | Dia     | 05      | 17.167 |\n| 10615 | 2016-10-03 17:22:00 | W      | 84      | Dia     | 05      | 17.367 |\n| 10615 | 2016-10-03 18:46:00 | S      | 93      | Dia     | 05      | 18.767 |\n| 10615 | 2016-10-03 20:19:00 | W      | 134     | Dia     | 05      | 20.317 |\n\nSegún la configuración: La primera vigilia que ocurre después de las 06:00 que dura al menos 1800 segundos (30 min) y que tenga menos de 300 segundos de sueño (imagino que según estado actigráfico de MiniMitter) corresponde a la vigilia de las 11:02. Algo pasó entre medio que llevó al programa a hacer esto, lamentablemente no tengo como revisar el código.\n\n> Nota mental:\n> En la app nueva no se considera el parámetro de *AwakeMaximumSleep* (o de sueño), porque es redundante e induce error.\n>\n> Al usar el parámetro *StateFilterDuration* para definir un episodio de sueño o vigilia consolidado se descarta de antemano aquellos epoch detectados como sueño por el algoritmo de MiniMitter. O sea, si en un episodio determinado como vigilia tiene dentro una secuencia `W W S S S W W` esos *epoch* de sueño no serán considerados como cambio de estado porque no son suficientes, esto se hace en `Actividorm` como en la app nueva, es decir, hay una regla para determinar cuando cambia un estado. \n>\n> Por otra parte usar este parámetro es problemático porque correlaciona con la duración del episodio. Es decir, un episodio de vigilia (por ejemplo) tendrá más *epoch* de sueño según el algoritmo de MiniMitter mientras mayor sea la duración del episodio. La consecuencia puede ser (por ejemplo) **descartar un una vigilia que defina el inicio de día** porque supera el parámetro de cantidad de sueño MiniMitter.\n>\n> Como la cantidad de sueño (para el ejemplo) MiniMitter depende de la duración del episodio puede ocurrir que si un sujeto estuvo despierto todo el día y de cuando en vez no se mueve y el algoritmo dice sueño y al sumar estos *epoch* habrá mucho sueño y si se supera este parámetro no habrá inicio de día. Pero estuvo despierto todo el día (según actograma) y se perdería en el recuento final y eso ocurre a veces con `Actividorm`.\n\n------\n\n# 2. Conteo de episodios\n\nEsta sección se ocupa de contar los episodios del período y calcular su porcentaje. Los períodos de análisis pueden ser de noche o día porque tienen la misma estructura. Por ejemplo este extracto es la **Noche 02** del sujeto **10648** y contiene 3 episodios, 2 de sueño y 1 de vigilia. \n\n```\n   id            fec.hora estado dur_min mean_act actividad   hora     dia hora.abs  periodo\n10648 2016-09-14 22:18:00      S     494      6.5      3231 22.300 mié-jue       22 Noche 02\n10648 2016-09-15 06:32:00      W      42     67.3      2826  6.533 mié-jue        6 Noche 02\n10648 2016-09-15 07:14:00      S      31      9.0       278  7.233 mié-jue        7 Noche 02\n```\n\n## Conteos \n\nLo siguiente son los conteos generales y sus porcentajes tienen la siguiente estructura y se usa para la misma para las mitades. Tenemos:\n\n| Variable | Descripción                                       |\n| -------- | ------------------------------------------------- |\n| nS       | Número de episodios de Sueño                      |\n| nW       | Número de episodios de Vigilia (Wakeness)         |\n| nTot     | Número Total de episodios                         |\n| pS       | Porcentaje de episodios de sueño sobre el total   |\n| pW       | Porcentaje de episodios de Vigilia sobre el total |\n\n**Existe una excepción**: en caso que el sujeto sólo tenga un episodio en el período, en la noche por ejemplo: porque durmió de corrido todo el período. Igual se van a capturar sus estadísticas de conteos porque aunque son escasas las ocurrencias puede ser necesario describir esta situación. Pero **se recomienda filtrarlas antes de hacer análisis** para que no afecte los cálculos promediados ya que valores de 0 y 100 en el porcentaje va a subestimar y sobreestimar los promedios de forma dramática y no es recomendable si se quiere obtener estadísticas representativas de los períodos que sí tienen datos válidos.\n\n## Conteos en Mitades \n\nCuando se divide un período y se cuentan episodios en tales mitades hay que considerar algunas cosas, si bien el proceso de contar es el mismo se deben definir varias cosas primero:\n\n### Calcular la mitad del período\n\nLo primero es calcular la mitad del período, como se cuenta con la hora de inicio de cada episodio y su duración se puede calcular de esta forma. Se entiende como fecha-hora al constructo de tipo `30-06-2020 23:59:00`.\n\n```\nFecha.Hora.Inicio = Fecha.Hora (Primer episodio)\n\nFecha.Hora.Final = Fecha.Hora (último episodio) + duración (último episodio)\n\nFecha.Hora.Mitad = Fecha.Hora.Inicio + minutos((Fecha.Hora.Final - Fecha.Hora.Inicio)/2)\n```\n\nSegún esa `Fecha.Hora.Mitad` se asignarán los diferentes episodios a cada mitad de la **noche o día** según corresponda. \n\n\n\n**Importante a considerar**: Cuando se habla de mitades se asume que existen ocurrencias en ambas mitades, una persona no puede tener una sola mitad, siempre tendrá 2 y por esa razón un sujeto que duerme de corrido (o no duerme siestas) no será incluida en el cálculo de mitades de noche o día.\n\nLa razón es la siguiente. \n\n* Si asigno ese único episodio a la 1ra mitad, la segunda quedará en blanco y no se puede tener una sola mitad.\n* Si asigno uno en cada mitad tendría entonces 2 episodios, no uno.\n* Además no se puede tener 2 episodios iguales seguidos, 2 episodios de sueño tienen que estar separados por una vigilia y viceversa.\n* De lo anterior se desprende que la cantidad de episodios mínima para hacer cálculos es de 3 episodios en un período. \n\n\n\n**Un caso a considerar:** Se podría pensar que alguien que duerme algo en la noche y se desvela podría tener 2 episodios en una noche, sin embargo el `actividorm` (y la app nueva) determina que el día comienza cuando encuentra la primera vigilia que dure **x** minutos y que sea posterior a **x** hora. \n\nEntonces si se desveló y pasó la hora que determina el inicio del día, aun se debe localizar el episodio que inicia el día, por lo tanto el sistema comenzará el día en la siguiente vigilia que dure más de **x** minutos y por lo tanto deberá existir un sueño antes de ese episodio y por eso un período de 2 episodios no puede ocurrir. Lo mismo ocurre en la noche.\n\nCuando un sujeto se duerme y despierta antes de la hora de inicio del día y no duerme hasta la noche el `actividorm` se vuelve loco (noches que duran hasta las 7PM y cosas así.), en el sistema nuevo cuando pasa esto se fuerza que el inicio del día sea a la hora configurada (o marcada en la app) para asegurar la utilidad de ese día y dar cierre a esa noche. \n\nGráficamente el inicio del día luce así:\n\n``` \n|-> Inicio Noche                                         |-> Desde acá comienza el dia\n|                                                        |   según el sistema Actividorm\n+----------+-------------------------|-----------+-------+-----------------------------\n| Sleep    |  Wake                   |           | Sleep |  Wake (Duración > x min.)   \n+----------+-------------------------|-----------+-------+-----------------------------\n                                     | \n                               Hora Inicio Día (Settings)\n```\n\nNo se puede adaptar el `actividorm`  a lo que hace la app nueva porque el archivo de episodios ya está creado y en la app nueva esta distinción se hace antes de la creación del archivo de episodios. Ocurre que este archivo de episodios de sueño y vigilia es la clave para calcular las estadísticas generales, es el origen de todo (⌐■_■).\n\n### Asignación episodio que cruza la mitad\n\nAunque puede ocurrir que un episodio comience justo en la `Fecha.Hora` de la mitad de la noche la mayoría de las veces existirá un episodio que cruza tal hora. Existen dos formas de asignar ese episodio a una mitad de período, por ejemplo en el siguiente diagrama:\n\n```\n                                  Mitad\n                                    |\n+--------------------------------+--|-------------------------+---------+\n|    Sleep                       |  |       Wake              | Sleep   |\n+--------------------------------+--|-------------------------+---------+\n          Primera Mitad             |           Segunda Mitad\n```\n\n### Versión 1. Según hora\n\nEn esta variante los episodios se asignan a cada mitad **según la hora en que comienza el episodio**. Da igual que la mayor parte de un episodio que cruza la hora de la mitad del período se encuentre en la segunda parte.\n\nPor ejemplo en el diagrama el episodio de vigilia a pesar de distribuirse principalmente en la segunda mitad será asignado a la primera mitad porque se inicia en esa parte.\n\n* Entonces en este caso la primera mitad tendrá 2 episodios uno de sueño y otro de vigilia\n* La segunda mitad sólo tendrá un episodio de sueño y ausencia de vigilia.\n\nComo una persona no puede tener datos en una sola mitad **existe una excepción a esta regla**: Si ocurriera que todos los episodios se inician en la 1ra mitad significa que el último abarca toda la segunda mitad, razón por la cual será asignado a la segunda mitad.\n\n> La variable de versión 1 se indican con el sufijo `v1`\n\n### Versión 2. Según proporción\n\nEsta variante asigna el episodio que cruza a la `Fecha.Hora` de la mitad del período según en qué mitad tiene mayor proporción. De esta forma se evita la excepción de la **Versión 1**. \n\n> Las variables de versión 2 se indican con el sufijo `v2`\n>\n> `Actividorm` **usa la versión 2 para signar el episodio que cruza la mitad**\n\n### Cálculos\n\nLos cálculos entonces son los mismos que para los conteos globales, solo que se aplican a los episodios de cada mitad.\n\n> Nota mental:\n>\n> Mientras se reescribió el script de conteos encontré que si a la hora de inicio de un episodio se le suma la duración en minutos, el final no calza con el inicio del siguiente según los datos del `Actividorm`. (-_-)\n>\n> Por ejemplo si tengo un episodio con hora `10:20` y duración `8` el episodio termina entonces a las `10:28:59` entonces el siguiente episodio tiene que comenzar a las `10:29`, pero a veces nup.\n>\n> Este error del `Actividorm` provoca que no se puedan asignar correctamente los episodios a cada mitad, razón por la cual hubo que recalcular la duración de los episodios. \n>\n> En la app nueva esto no ocurre, *\"todo calza\"*   ⌐■_■\n>\n\n\n\n## Variables de Conteos\n\nLos códigos de las variables son las siguientes. Obvio que las divisiones son solo para orden mental.\n\n```\nVariables\tDescripción\n------------------------------------------------------------------------\nid\t\t\tId del sujeto\ndia.noc\t\tDia o Noche d\nperiodo\t\tPeríodo de análisis\nwday\t\tDia de la semana de la fecha (formato transito para la noche)\n------------------------------------------------------------------------\nnS\t\t\tN° de episodios de Sueño del período\nnW\t\t\tN° de episodios de Vigilia del período\nnTot\t\tN° Total de episodios del período\npS\t\t\tPorcentaje de períodos de sueño sobre el total\npW\t\t\tPorcentaje de períodos de Vigilia sobre el total\n------------------------------------------------------------------------\nnS_M1v1\t\tN° de episodios de Sueño \t\t\tMitad 1, Version 1\nnW_M1v1\t\tN° de episodios de Vigilia\t\t\tMitad 1, Version 1\nnTot_M1v1\tN° Total de episodios\t\t\t\tMitad 1, Version 1\npS_M1v1\t\tPorcentaje de períodos de sueño\t\tMitad 1, Version 1\npW_M1v1\t\tPorcentaje de períodos de Vigilia\tMitad 1, Version 1\n------------------------------------------------------------------------\nnS_M2v1\t\tN° de episodios de Sueño\t\t\tMitad 2, Version 1\t\nnW_M2v1\t\tN° de episodios de Vigilia\t\t\tMitad 2, Version 1\nnTot_M2v1\tN° Total de episodios\t\t\t\tMitad 2, Version 1\npS_M2v1\t\tPorcentaje de períodos de sueño\t\tMitad 2, Version 1\npW_M2v1 \tPorcentaje de períodos de Vigilia\tMitad 2, Version 1\n------------------------------------------------------------------------\nnS_M1v2\t\tN° de episodios de Sueño\t\t\tMitad 1, Version 2\nnW_M1v2\t\tN° de episodios de Vigilia\t\t\tMitad 1, Version 2\nnTot_M1v2\tN° Total de episodios\t\t\t\tMitad 1, Version 2\npS_M1v2\t\tPorcentaje de períodos de sueño\t\tMitad 1, Version 2\npW_M1v2\t\tPorcentaje de períodos de Vigilia\tMitad 1, Version 2\n------------------------------------------------------------------------\nnS_M2v2\t\tN° de episodios de Sueño\t\t\tMitad 2, Version 2\nnW_M2v2\t\tN° de episodios de Vigilia\t\t\tMitad 2, Version 2\nnTot_M2v2\tN° Total de episodios\t\t\t\tMitad 2, Version 2\npS_M2v2\t\tPorcentaje de períodos de sueño\t\tMitad 2, Version 2\npW_M2v2\t\tPorcentaje de períodos de Vigilia\tMitad 2, Version 2\n------------------------------------------------------------------------\nkey\t\t\tPara cruzar bases de datos (identifica id + periodo)\n```\n\n------\n\n# 3. Duración de estados\n\nEsta sección calcula la duración en minutos de los episodios de sueño y vigilia además del porcentaje de los episodios. Por ejemplo este extracto es la **Noche 02** del sujeto **10648** y contiene 3 episodios, 2 de sueño y 1 de vigilia. \n\n```\n   id            fec.hora estado dur_min mean_act actividad   hora     dia hora.abs  periodo\n10648 2016-09-14 22:18:00      S     494      6.5      3231 22.300 mié-jue       22 Noche 02\n10648 2016-09-15 06:32:00      W      42     67.3      2826  6.533 mié-jue        6 Noche 02\n10648 2016-09-15 07:14:00      S      31      9.0       278  7.233 mié-jue        7 Noche 02\n```\n\nPara hacer el cálculo se usa la variable de duración del episodio `dur_min` (en minutos), en el caso del `Actividorm` que tiene errores en la asignación de esta variable pueden existir mínimas discrepancias si se hace al cálculo a mano (Ya lo expliqué).\n\nCabe destacar que la función de cálculo es un poco lenta debido a que usa una estrategia de expansión de la data porque fue creada durante el proceso de análisis de actividad. Se podría re escribir, pero funciona y no se modificó su estructura.\n\n\n## Duraciones generales\n\nEste es un ejemplo de un bloque de duraciones globales.\n\n```\n  Stime Wtime Ttime Spct Wpct\n    525    42   567 92.6  7.4\n```\n\nLas variables `Stime`, `Wtime` y el `Ttime` se encuentra en minutos. `Spct` y  `Wpct` corresponden al porcentaje de la duración sobre el total. Es lo mismo para calcular duraciones en mitades y tercios.\n\n## Duraciones en Mitad y Tercios\n\nAdemás de las duraciones totales se particionó la noche de cada sujeto en mitades y tercios. A estos segmentos se le aplicaron las mismas variables que en las duraciones generales.\n\n> En el caso de las duraciones no se asignan episodios a mitades o tercios sino que se calcula de forma precisa cuántos minutos hay en un tercio o mitad de noche.\n\nPara hacer los cálculos  de mitades y tercios se toma la duración de la noche o día y se particiona según el procedimiento explicado en los conteos. Luego con estas horas de corte se calcula la cantidad precisa de minutos existentes en casa partición.\n\n## Promedios\n\nEn esta sección se calculan los valores promedios de los episodios de sueño y vigilia para los episodios, no se hace el calculo en mitades o tercios por la baja frecuencia de episodios que suele observarse.\n\nA pesar que en términos de la estadística más básica posible calcular el promedio de una constante (un solo valor) es, por decir lo menos, absurdo... igual se hace, porque `Actividorm` lo hace `¯\\_(ツ)_/¯`. \n\nDicho esto **se recomienda encarecidamente no considerar promedios basados en una observación**, o sea no usarlos para análisis. Es más, no recomiendo usar esta variable porque es muy inestable y no refleja en absoluto lo que pretende, por ejemplo:\n\n> Si un sujeto duerme toda la noche, unos 450 minutos, se despierta 10 minutos y luego duerme otros 10 (esto es bien común por cierto) el promedio calculado será 450+10/2 = 230 minutos.\n>\n> O sea se tiende a pensar que el sujeto durmió un par de episodios de 230 minutos, pero no es así.\n\n<img src=\"https://i.imgur.com/bWS4Lv9.png\" style=\"zoom:67%;\" />\n\nSi graficamos N° de Sueños vs Promedio de sueños (en la noche) como se ve aquí (en wawas de 6 meses) vemos que la mayoría de los promedios se basan en 1 observación, quizás 2 o 3. Entonces con juicio estadístico diremos que esta variable no tiene valor analítico, es decir, lo que se saque de esta variable no significa nada. Dicho de otra forma, afirmar que el promedio de los episodios de sueño de un grupo u otro no solo será pretencioso, sino quizás equivocado.\n\n> Otra cosa sería calcular el promedio ponderado a la duración, pero eso será para una próxima versión.\n\n## Variables de duración\n\nLos códigos de las variables son las siguientes. Obvio que las divisiones son solo para orden mental.\n\n```\nVariable\tDescripción\n------------------------------------------------------------------------\nid \t\t\tId del sujeto\ndia.noc\t\tDia o noche del período\nperiodo\t\tPeríodo en análisis\nwday\t\tDia de la semana de la fecha (formato transito para la noche)\n------------------------------------------------------------------------\nnS\t\t\tN° de episodios de sueño del período\nnW\t\t\tN° de episodios de vigilia del período\nnTot\t\tN° de episodios del período\nStime\t\tSuma duración sueño período\nWtime\t\tSuma duración vigilia períodos\nTtime\t\tSuma total del período (duración período)\nSpct\t\tPorcentaje duración sueño sobre total\nWpct\t\tPorcentaje duración vigilia sobre total\nSmean\t\tPromedio duración episodios de sueño\nWmean\t\tPromedio duración episodios de vigilia\nTmean\t\tPromedio duración episodios el período\n------------------------------------------------------------------------\nT1S\t\t\tDuración sueño \t\tTercio 1\nT1W\t\t\tDuración vigilia \tTercio 1\nT2S\t\t\tDuración Sueño \t\tTercio 2\nT2W\t\t\tDuración Vigilia \tTercio 2\nT3S\t\t\tDuración Sueño \t\tTercio 3\nT3W\t\t\tDuración Vigilia \tTercio 3\nT1tot\t\tDuración del tercio 1\nT1Sp\t\tPorcentaje Sueño\tTercio 1\nT1Wp\t\tPorcentaje Vigilia \tTercio 1\nT2tot\t\tDuración del tercio 2\nT2Sp\t\tPorcentaje Sueño\tTercio 2\nT2Wp\t\tPorcentaje Vigilia \tTercio 2\nT3tot\t\tDuración del tercio 3\nT3Sp\t\tPorcentaje Sueño\tTercio 3\nT3Wp\t\tPorcentaje Vigilia \tTercio 3\n------------------------------------------------------------------------\nM1S\t\t\tDuración sueño \t\tMitad 1\nM1W\t\t\tDuración vigilia \tMitad 1\nM2S\t\t\tDuración sueño \t\tMitad 2\nM2W\t\t\tDuración vigilia \tMitad 2\nM1tot\t\tDuración mitad 1\nM1Sp\t\tPorcentaje sueño \tMitad 1\nM1Wp\t\tPorcentaje vigilia\tMitad 1\nM2tot\t\tDuración mitad 2\nM2Sp\t\tPorcentaje sueño \tMitad 2\nM2Wp\t\tPorcentaje Vigilia\tMitad 2\n------------------------------------------------------------------------\nkey\t\t\tPara cruzar bases de datos (identifica id + periodo)\n```\n\n------\n\n# 4. Duración máxima\n\nEsta parte calcula o busca aquellos episodios que representan la máxima duración de un período. Por ejemplo este extracto es la **Noche 02** del sujeto **10648** y contiene 3 episodios, 2 de sueño y 1 de vigilia. \n\n```\n   id            fec.hora estado dur_min mean_act actividad   hora     dia hora.abs  periodo\n10648 2016-09-14 22:18:00      S     494      6.5      3231 22.300 mié-jue       22 Noche 02\n10648 2016-09-15 06:32:00      W      42     67.3      2826  6.533 mié-jue        6 Noche 02\n10648 2016-09-15 07:14:00      S      31      9.0       278  7.233 mié-jue        7 Noche 02\n```\n\nLo primero a tener en consideración es que un **máximo implica que si o si un período tiene al menos existen 2 episodios** para poder calcular. \n\n> No existe valor máximo para una constante, por ejemplo: El valor máximo de 10 no existe.\n\nEsto limita el cálculo de esta estadística a aquellos periodos (u otro segmento) que posea al menos 2 episodios del mismo tipo, por ejemplo:\n\n| Secuencia Noche   | Secuencia Dia     | Status estadística duración máxima                           |\n| ----------------- | ----------------- | ------------------------------------------------------------ |\n| S                 | W                 | No permite calcular duración máxima                          |\n| S - W - S         | W - S - W         | Permite el cálculo de sólo 1 máximo                          |\n| S - W - S - W - S | W - S - W - S - W | A partir de cinco episodios se pueden calcular máximos a los dos estados |\n\n**Esto opera para cualquier partición de la noche o el día**, es decir, si se desea conocer cuál es el episodio de sueño más largo de la segunda mitad de la noche se requiere que tenga al menos 3 episodios con la secuencia `S - W - S`. Lo mismo para el día.\n\nCuando no se pueda calcular se dejará el valor correspondiente como valor faltante `NA`.\n\n## Máximos en mitades\n\nDada la certeza anterior para que se pueda calcular máximos en mitades de noche o día (es igual el cálculo) se requiere un mínimo de 3 episodios y por lo tanto **asignar los episodios a mitades**. Para esto se utilizará la estrategia de asignar los episodios según en qué mitad tengan la mayor parte de su duración, versión 2 en la sección conteos.\n\n## Variables de máximos\n\n```\nVariable\tDescripción\n------------------------------------------------------------------------\nid \t\t\tId del sujeto\ndia.noc\t\tDia o noche del período\nperiodo\t\tPeríodo en análisis\nwday\t\tDia de la semana de la fecha (formato transito para la noche)\n------------------------------------------------------------------------\ndurSmax\t\tDuración sueño máximo del período \nlocSmax \tLocalización sueño máximo del período (Según mitad)\nmidSmax \tPunto medio (hora decimal) del sueño más largo del período\ndurWmax \tDuración vigilia máximo del período \nlocWmax \tLocalización vigilia máxima del período (Según mitad)\nmidWmax \tPunto medio (hora decimal) de vigilia más larga del período\n------------------------------------------------------------------------\ndurSmax_M1\tDuración sueño máximo \t\t\t\t\tMitad 1 \nmidSmax_M1  Punto medio (decimal) del sueño máximo\tMitad 1\ndurWmax_M1  Duración vigilia máxima \t\t\t\tMitad 1\nmidWmax_M1\tPunto medio (decimal) vigilia máxima\tMitad 1\ndurSmax_M2  Duración sueño máximo \t\t\t\t\tMitad 2 \nmidSmax_M2\tPunto medio (decimal) del sueño máximo\tMitad 2 \ndurWmax_M2\tDuración vigilia máxima \t\t\t\tMitad 2 \nmidWmax_M2\tPunto medio (decimal) vigilia máxima\tMitad 2\n------------------------------------------------------------------------\nkey\t\t\tPara cruzar bases de datos (identifica id + periodo)\n```\n\n> Queda pendiente incluir máximos por mitades asignando episodios según hora de inicio.\n\n------\n\n# 5. Latencias\n\nPara el cálculo de latencias es el mismo procedimiento de selección del período. Por ejemplo este extracto es la **Noche 02** del sujeto **10648** y contiene 3 episodios, 2 de sueño y 1 de vigilia. \n\n```\n   id            fec.hora estado dur_min mean_act actividad   hora     dia hora.abs  periodo\n10648 2016-09-14 22:18:00      S     494      6.5      3231 22.300 mié-jue       22 Noche 02\n10648 2016-09-15 06:32:00      W      42     67.3      2826  6.533 mié-jue        6 Noche 02\n10648 2016-09-15 07:14:00      S      31      9.0       278  7.233 mié-jue        7 Noche 02\n```\n\nA diferencia del resto de los script de cálculo en esto de las latencias hay distinciones que hacer entre día y noche, por ejemplo la latencia a la primera siesta y a la primera vigilia es la misma variable dependiendo si el período es día o noche.\n\n## Latencias del inicio\n\nLo primero a registrar son las latencias que ocurren al inicio del período hasta el segundo despertar en el caso de la noche o segundo sueño en caso que el período sea día (es la misma variable).\n\nDemás está decir que si el sujeto sólo tiene un estado porque duerme de corrido (por ejemplo) no se puede calcular nada, por lo cual solo se registrará valores faltantes. Las duraciones se calculan con la variable `dur_min`.\n\nSe registra la hora del episodio siguiente como latencia para asegurar que exista un próximo episodio. Por ejemplo en la noche.\n\n```\n       /  -------                 \\             \\             \\\n      |      S                     | Dur.1ra.Lat |             |\n      |   ------- < Hr.1ra.Lat -- /              | Dur.2da.Lat |\n      |      W                                   |             | Dur.3ra.Lat\n      |   ------- < Hr.2da.Lat ---------------- /              |\nNoche |      S                                                 |\n      |   ------- < Hr.3ra.Lat ------------------------------ /\n      |      W\n      |   -------\n      |      S\n       \\  -------\n```\n\nPara el día funciona igual pero en lugar de sueño es vigilia.\n\n```\n       /  -------                 \\             \\             \\\n      |      W                     | Dur.1ra.Lat |             |\n      |   ------- < Hr.1ra.Lat -- /              | Dur.2da.Lat |\n      |      S                                   |             | Dur.3ra.Lat\n      |   ------- < Hr.2da.Lat ---------------- /              |\nDía   |      W                                                 |\n      |   ------- < Hr.3ra.Lat ------------------------------ /\n      |      S\n      |   -------\n      |      W\n       \\  -------\n```\n\nPara registrar la hora y duración de la primera latencia se necesita que existan al menos 3 episodios y para el resto de variables al menos 5 episodios. Si no hay episodios suficiente se rellena con valores faltantes.\n\n## Latencia del final\n\nTambién se registra la hora de inicio y duración del último episodio del período, porque en el caso del día corresponde a la latencia de dormir. Cuyo efecto se puede medir si se cuenta con el período consecutivo siguiente.\n\n## Variables Latencia\n\n```\nVariable\tDescripción\n------------------------------------------------------------------------\nid \t\t\tId del sujeto\ndia.noc\t\tDia o noche del período\nperiodo\t\tPeríodo en análisis\nwday\t\tDia de la semana de la fecha (formato transito para la noche)\n------------------------------------------------------------------------\nn_epi\t\tNúmero de episodios del período\nlat_date\tFecha del primer episodio (para chequeos)\nlat1_hora\tHora 1ra latencia (Hora inicio 2do episodio)\nlat1_dur\tDuración 1ra latencia (Duración 1er episodio)\nlat2_hora\tHora 2da latencia (Hora inicio 3er episodio)\nlat2_dur\tDuración 2da latencia (Duración 1er + 2do episodio)\nlat3_hora\tHora 3ra latencia (Hora inicio 4to episodio)\nlat3_dur\tDuración 3ra latencia (Duración 1er + 2do + 3er episodio)\n------------------------------------------------------------------------\ndurEpi2\t\tDuración 2do episodio\ndurEpi3\t\tDuración 3er episodio\nlatU_hora\tHora de inicio último episodio (latencia dormir si es día)\nlatU_dur\tDuración último episodio\n------------------------------------------------------------------------\nkey\t\t\tPara cruzar bases de datos (identifica id + periodo)\n```\n\n> Como puede adivinarse:\n>\n> * El primer episodio es Vigilia si el período es día\n> * El primer episodio es Sueño si el período es noche\n>\n> Y así sucesivamente :stuck_out_tongue_winking_eye:\n>\n> Por ejemplo: la variable **latency to second nap since end of first nap** sería la duración del 3er episodio cuando el período es día :smirk:\n\n------\n\n# 6. Día completo\n\nSi una persona usara de forma continua el actígrafo desde que sale del laboratorio hasta que vuelve no se necesitarían ediciones manuales, app nueva y el `Actividorm` funcionaría perfecto.\n\nComo no es el caso se deben borrar de forma rutinaria períodos completos, dejando lagunas en los registros que dificultan el cálculo de estadísticas de día completo. Para poder tener acceso a este tipo de análisis lo primero es buscar en todos los períodos de un sujeto cuales son consecutivos.\n\n**Noche a Día**: Este tipo de registro de 24 horas comienza con la noche y en términos del registro secuencial de periodos necesita de la existencia de pares de períodos de tipo `Noche 03 & Dia 03` .\n\n**Día a Noche**: Este tipo de registro de 24 horas inicia en el día y termina al día siguiente (al término de la noche), en términos de las secuencias de `Actividorm` o la app nueva son del tipo `Dia 03 & Noche 04`.\n\nEntonces para cada sujeto hay que buscar en sus registros válidos cuantos de estos pares existen.\n\n## Períodos consecutivos\n\nCuando se encuentren pares de períodos que sirvan para hacer cálculos de día completo la unidad de análisis ahora es un par de períodos y en 2 versiones **Noche a Día** y **Dia a Noche**.\n\nUna vez identificadas las combinaciones que tiene el sujeto se tendrá esta estructura.\n\n| id    | tipo        | combi             | filtro1  | filtro2  |\n| ----- | ----------- | ----------------- | -------- | -------- |\n| 10207 | Dia a Noche | Dia 02 - Noche 03 | Dia 02   | Noche 03 |\n| 10207 | Dia a Noche | Dia 05 - Noche 06 | Dia 05   | Noche 06 |\n| 10207 | Dia a Noche | Dia 06 - Noche 07 | Dia 06   | Noche 07 |\n| 10207 | Dia a Noche | Dia 07 - Noche 08 | Dia 07   | Noche 08 |\n| 10207 | Noche a Dia | Noche 06 - Dia 06 | Noche 06 | Dia 06   |\n| 10207 | Noche a Dia | Noche 07 - Dia 07 | Noche 07 | Dia 07   |\n\nEntonces con las variables `filtro1` y `filtro2` se filtran los episodios del par de períodos y se calculan algunas estadísticas.\n\n### Sujetos sin pares válidos\n\nExiste la posibilidad que existan sujetos que no tienen pares de períodos consecutivos y en consecuencia no se les puede calcular nada.\n\n> Se registra esta ocurrencia en la tabla **drop** que contienen observaciones que se han descartado. Así se pueden realizar chequeos.\n\n## Variables día completo\n\n```\nVariable\tDescripción\n------------------------------------------------------------------------\nid \t\t\tId del sujeto\ntipo\t\tTipo de par (Dia a noche o Noche a dia)\nfiltro1\t\tPrimer elemento del par\nfiltro2\t\tSegundo elemento del par\ncombi\t\tCombinación del par (con número identificador)\nfecini\t\tFecha de inicio del primer par de períodos\ndias\t\tDías involucrados en el par\n------------------------------------------------------------------------\nnS_24\t\tN° de episodios de sueño \nnW_24\t\tN° de episodios de vigilia\nnTot_24\t\tN° Total de episodios\npS_24\t\tPorcentaje episodios de sueño sobre total\npW_24\t\tPorcentaje episodios de vigilia sobre el total\n------------------------------------------------------------------------\nSdur_24\t\tDuración del sueño\nWdur_24\t\tDuración de la vigilia\nTdur_24\t\tDuración total del par de períodos\nSpct_24\t\tPorcentaje de duración de sueño \nWpct_24\t\tPorcentaje de duración de vigilia\n------------------------------------------------------------------------\niniSMax_24\tHora inicio episodio sueño máximo en formato HH:MM (Para chequeos)\niniSMax2_24\tHora inicio episodio sueño máximo (decimal)\nmidSMax_24\tHora mitad episodio sueño máximo (decimal)\nperSmax_24\tPeríodo al cual pertenece el episodio de sueño máximo\ndurSmax_24\tDuración del episodio de sueño máximo\n------------------------------------------------------------------------\niniWMax_24\tHora inicio episodio vigilia máxima en formato HH:MM (Para chequeos)\niniWMax2_24\tHora inicio episodio vigilia máxima (decimal)\nmidWMax_24\tHora mitad episodio vigilia máxima (decimal)\nperWmax_24\tPeríodo al cual pertenece el episodio de vigilia máxima\ndurWmax_24\tDuración del episodio de vigilia máxima\n```\n\nComo es lógico esta sección no contiene la `key` para cruzar con otras bases de datos porque cada registro corresponde a estadísticas de 2 períodos.\n\n------\n\n# 7. Causa efecto\n\nEste tipo de resultado no son cálculos de estadísticas propiamente tales, corresponde a los pares de períodos válidos que tiene cada sujetos, ya están disponibles en las estadísticas de día completo.\n\nSe dejan aparte con el objeto de poder filtrar pares de variables de las otras tablas de datos y que pudieran tener un valor predictor en el ambiente de 24 horas. Tiene la siguiente estructura:\n\n```\n     id        tipo             combi  filtro1  filtro2\n  10013 Dia a Noche Dia 02 - Noche 03   Dia 02 Noche 03\n  10013 Dia a Noche Dia 03 - Noche 04   Dia 03 Noche 04\n  10013 Dia a Noche Dia 04 - Noche 05   Dia 04 Noche 05\n  10013 Noche a Dia Noche 02 - Dia 02 Noche 02   Dia 02\n  10013 Noche a Dia Noche 03 - Dia 03 Noche 03   Dia 03\n  10013 Noche a Dia Noche 04 - Dia 04 Noche 04   Dia 04\n```\n\n## Un ejemplo\n\nUn par de variables que pudiera ser filtrado a partir de estos registros es (usando la primera línea) por ejemplo:\n\n```\nid = 10013\nfiltro1 = Dia 02\nfiltro2 = Noche 03\nTabla conteos:  [N° Episodios Sueño]\nTabla duración: [Duración sueño nocturno]\n```\n\nDe esa forma se podrán hacer análisis más elaborado, pero como las combinaciones son demasiadas no se pueden calcular todas, pero se podría programar un `loop` o algo parecido para cada fila de esta tabla de pares.\n\n> El resultado será para cada sujeto un set de pares de variable, según tenga pares disponibles. No serán los mismo pares en todos los sujetos, aunque quizás se pueda filtrar a posterior las mayores ocurrencias de pares específicos.\n\nLa secuencia lógica para capturar las 2 variables de interés en general \n\n1. Capturar la línea de pares de períodos (ejemplo: `Dia 02 - Noche 03`) de la tabla `CausaEfecto`\n2. De esa línea guardar el valor de `filtro1`, `filtro2` y el `id`.\n\n   * Crear una `key` con el `id` y el valor de `filtro1` del tipo `10013_Dia_02`\n   * Usando esta `key` ir a la tabla `conteos` y capturar la variable `[N° Episodios Sueño]`\n   * Crear otra `key` pera el `id` y el valor de `filtro2` del tipo `10013_Noche_03`\n   * Usando esta `key` ir a la tabla `duracion` y capturar la variable `[Duración sueño nocturno]`\n3. Crear un `data.frame` con la información de la línea de la tabla `CausaEfecto` + los 2 registros capturados.\n4. Apilar todas las líneas procesadas.\n5. Et voila\n\nTendremos como resultado las variables de la tabla `CausaEfecto` + 2 variables. Con eso se puede hacer análisis.\n\n> Pero alguien tendrá que que programarlo.\n\n------\n\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"css":["../styles.css"],"output-file":"readme.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.5.57","editor":"visual","theme":"cosmo","toc-title":"Contenido"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}